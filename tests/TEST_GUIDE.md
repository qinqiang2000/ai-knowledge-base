# Customer Service Skill 测试指南

本指南说明如何测试 `customer-service` skill。

## 📁 测试文件

| 文件 | 用途 |
|------|------|
| `test_customer_service_skill.py` | 完整测试套件（10个场景） |
| `test_skill_quick.py` | 快速测试脚本（4个核心场景） |

## 🚀 快速开始

### 1. 激活环境

```bash
source .venv/bin/activate
source .env.prod  # 如果需要加载环境变量
```

### 2. 运行快速测试

```bash
python tests/test_skill_quick.py
```

这将测试 4 个核心场景：
- ✅ 完整问题（标准版开票）
- ✅ 不完整问题（应询问产品）
- ✅ 产品区分（星瀚旗舰版）
- ✅ 辅助系统（乐企）

### 3. 自定义测试查询

```bash
# 测试单个查询
python tests/test_skill_quick.py "aws发票云的影像功能在哪里？"

# 测试 API 问题
python tests/test_skill_quick.py "开票接口的 API 文档在哪里？"

# 测试同义词
python tests/test_skill_quick.py "EOP系统怎么查看订单状态？"
```

## 🧪 运行完整测试套件

完整测试包含 10 个场景，覆盖所有功能点：

```bash
python tests/test_customer_service_skill.py
```

### 测试场景列表

1. **产品识别** - 标准版开票配置
2. **产品区分** - 星瀚旗舰版收票流程
3. **问题完整性** - 缺少产品信息时的处理
4. **API 问题** - 接口文档查询
5. **辅助系统** - 乐企配置
6. **同义词识别** - EOP = 订单系统
7. **同义词识别** - RPA通道
8. **未找到答案** - 标准回复测试
9. **产品同义词** - aws发票云 = 标准版
10. **版本发布** - 星瀚 V8.0 新功能

## ✅ 验证要点

运行测试时，关注以下几点：

### 1. 问题完整性检查

**完整问题** → 应该直接搜索：
```
输入: "标准版开票如何配置数电票？"
预期: 直接搜索 kb/产品与交付知识/11-常见问题/标准版发票云问题/
```

**不完整问题** → 应该先询问：
```
输入: "如何开票？"
预期: 询问"请问您使用的是哪个产品？"
      不应该搜索所有产品
```

### 2. 产品线识别

```
输入: "星瀚旗舰版收票勾选流程是什么？"
预期:
  - 识别产品：星瀚旗舰版
  - 识别模块：收票
  - 搜索星瀚相关文档
  - 不应混淆标准版或星空旗舰版
```

### 3. 同义词处理

```
输入: "aws发票云的影像功能在哪里？"
预期: 识别 aws发票云 = 标准版

输入: "EOP系统怎么查看订单？"
预期: 识别 EOP = 发票云订单系统

输入: "RPA通道配置失败"
预期: 识别 RPA通道 = 电子税局通道管理
```

### 4. 搜索策略

**API 问题：**
```
输入: "开票接口的 API 文档在哪里？"
预期: 优先搜索 kb/API文档/
```

**产品问题：**
```
搜索顺序:
1. kb/产品与交付知识/11-常见问题/{对应产品}/
2. kb/产品与交付知识/01-交付赋能/
3. 全局搜索
```

### 5. 未找到答案

```
输入: "如何使用发票云对接火星系统？"
预期: "抱歉，在发票云知识库没找到本答案，请联系发票云人工客服做支持。"
```

### 6. 工具使用

观察日志中的工具调用：
- `[🔍 搜索: ...]` - Grep 工具
- `[📖 读取: ...]` - Read 工具

检查：
- 是否使用了正确的搜索路径
- 是否使用了合适的关键词
- 是否避免了不必要的搜索

## 📊 测试输出示例

```
╭────────────────────────────────────────────╮
│ 发票云客服 Skill 快速测试                 │
╰────────────────────────────────────────────╯

【测试 1/4】

======================================================================
查询: 标准版开票如何配置数电票？
======================================================================

[🔍 搜索: 数电票.*配置 in ./data/kb/产品与交付知识/11-常见问题/标准版发票云问题/]
[📖 读取: ./data/kb/产品与交付知识/11-常见问题/一问一答/标准版/开票.md]

根据 [标准版开票FAQ](https://www.yuque.com/...) ...

✅ 测试完成
```

## 🐛 故障排查

### 问题：ModuleNotFoundError

```bash
# 确保已激活虚拟环境
source .venv/bin/activate

# 检查依赖
pip install -r requirements.txt
```

### 问题：找不到知识库

```bash
# 检查知识库路径
ls -la data/kb/

# 应该看到：
# data/kb/产品与交付知识/
# data/kb/API文档/
```

### 问题：Skill 未生效

```bash
# 检查 skill 文件是否存在
ls -la .claude/skills/customer-service/SKILL.md

# 查看 skill 内容
cat .claude/skills/customer-service/SKILL.md
```

## 📝 测试报告

运行完整测试后，会输出摘要：

```
==============================================================
测试摘要
==============================================================
总测试数: 10
通过: 10
失败: 0
```

## 🔄 持续测试

建议在以下情况重新运行测试：

- ✅ 修改 SKILL.md 后
- ✅ 更新知识库内容后
- ✅ 修改 prompt_builder.py 后
- ✅ 发现 skill 行为异常时

## 💡 提示

- 测试会实际调用 Claude API，会消耗 tokens
- 可以先运行快速测试（4个场景）验证基本功能
- 完整测试套件适合全面验证或 CI/CD 集成
- 使用自定义查询测试特定场景

## 📚 相关文件

- `.claude/skills/customer-service/SKILL.md` - Skill 定义
- `cli.py` - 命令行工具（默认使用 customer-service skill）
- `api/customer_service.py` - 客服 API 端点
- `data/kb/` - 知识库
